<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商家优惠券核销终端</title>
    <!-- 引入 Ethers.js (v5.7.2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE5B4 100%);
            min-height: 100vh;
            display: flex; 
            justify-content: center; 
            align-items: center;
            padding: 40px 20px;
        }
        
        .container { 
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFEF7 100%);
            padding: 45px 50px; 
            border-radius: 24px; 
            box-shadow: 0 12px 48px rgba(255, 193, 7, 0.25);
            width: 100%;
            max-width: 600px;
            border: 3px solid #FFD54F;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 { 
            text-align: center; 
            color: #F57C00;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(255, 193, 7, 0.1);
        }
        
        h3 {
            color: #F57C00;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .group { 
            margin-bottom: 18px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #E65100;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        input { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #FFE082; 
            border-radius: 12px; 
            box-sizing: border-box;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background: #FFFEF7;
        }
        
        input:focus {
            outline: none;
            border-color: #FFC107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }
        
        button { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn-connect { 
            background: linear-gradient(135deg, #FFD54F 0%, #FFC107 100%);
            color: #5D4037;
        }
        
        .btn-connect:hover {
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
        }
        
        .btn-verify { 
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
            color: #5D4037;
        }
        
        .btn-verify:hover:not(:disabled) {
            background: linear-gradient(135deg, #FFB300 0%, #FFA000 100%);
        }
        
        .btn-verify:disabled { 
            background: #E0E0E0;
            color: #9E9E9E;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #walletAddress {
            font-size: 0.85em;
            color: #795548;
            margin-top: 10px;
            padding: 10px;
            background: #FFF9E6;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        #status { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 12px; 
            font-size: 0.9em; 
            word-break: break-all;
            line-height: 1.6;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-info { 
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            color: #0D47A1;
            border: 2px solid #90CAF9;
        }
        
        .status-error { 
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            color: #C62828;
            border: 2px solid #EF9A9A;
        }
        
        .status-success { 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE082 100%);
            color: #F57C00;
            border: 2px solid #FFD54F;
        }
        
        .divider { 
            border-top: 2px dashed #FFE082; 
            margin: 25px 0;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>商家核销终端</h2>

    <!-- 连接钱包 -->
    <div class="group">
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">连接 MetaMask 钱包</button>
        <p id="walletAddress" style="font-size: 0.8em; text-align: center; margin-top: 5px; color: #888;">未连接</p>
    </div>

    <div class="group">
        <label>商家合约地址 (Merchant Contract):</label>
        <input type="text" id="merchantContractAddr" placeholder="0x..." value="">
    </div>

    <div class="divider"></div>

    <h3>模拟扫码结果</h3>
    <!-- 模拟扫描二维码得到的数据 -->
    <div class="group">
        <label>用户地址 (Consumer):</label>
        <input type="text" id="consumerAddr" placeholder="用户出示的二维码信息">
    </div>
    <div class="group">
        <label>优惠券地址 (Coupon):</label>
        <input type="text" id="couponAddr" placeholder="用户出示的二维码信息">
    </div>

    <div class="divider"></div>

    <div class="group">
        <label>本次消费金额 (Consume Value):</label>
        <input type="number" id="consumeValue" placeholder="请输入核销金额">
    </div>

    <button id="verifyBtn" class="btn-verify" onclick="verifyCoupon()" disabled>确认核销 (上链)</button>

    <div id="status"></div>
</div>

<script>
    let provider;
    let signer;
    let userAddress;

    // 只有 Merchant 合约的部分 ABI，只包含我们需要调用的 confirmCouponPay 函数
    const merchantAbi = [
        "function confirmCouponPay(uint consumeValue, bytes32 consumeDate, address couponAddr, address _consumer)"
    ];

    // 初始化检查
    window.onload = function() {
        if (typeof window.ethereum === 'undefined') {
            showStatus("未检测到 MetaMask，请安装插件。", "error");
        }
    };

    // 1. 连接钱包
    async function connectWallet() {
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            // 请求用户授权
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();

            document.getElementById("walletAddress").innerText = "当前商家账户: " + userAddress.substring(0, 6) + "..." + userAddress.substring(38);
            document.getElementById("connectBtn").innerText = "钱包已连接";
            document.getElementById("verifyBtn").disabled = false;
            showStatus("钱包连接成功！", "info");
        } catch (error) {
            console.error(error);
            showStatus("连接失败: " + error.message, "error");
        }
    }

    // 2. 核心核销函数
    async function verifyCoupon() {
        // 获取输入值
        const merchantContractAddr = document.getElementById("merchantContractAddr").value.trim();
        const consumerAddr = document.getElementById("consumerAddr").value.trim();
        const couponAddr = document.getElementById("couponAddr").value.trim();
        const consumeValue = document.getElementById("consumeValue").value.trim();

        // 基础校验
        if (!ethers.utils.isAddress(merchantContractAddr)) return showStatus("商家合约地址无效", "error");
        if (!ethers.utils.isAddress(consumerAddr)) return showStatus("用户地址无效", "error");
        if (!ethers.utils.isAddress(couponAddr)) return showStatus("优惠券地址无效", "error");
        if (!consumeValue || consumeValue <= 0) return showStatus("消费金额必须大于0", "error");

        try {
            showStatus("正在发起交易，请在 MetaMask 中确认...", "info");

            // 实例化合约
            const merchantContract = new ethers.Contract(merchantContractAddr, merchantAbi, signer);

            // 生成日期 (bytes32)
            // 合约要求 bytes32 类型的日期。我们将当前日期字符串 (如 "2023-11-29") 转为 bytes32
            const todayStr = new Date().toISOString().split('T')[0]; 
            const dateBytes32 = ethers.utils.formatBytes32String(todayStr);

            console.log("参数详情:", {
                value: consumeValue,
                date: dateBytes32,
                coupon: couponAddr,
                consumer: consumerAddr
            });

            // 调用合约函数: confirmCouponPay
            const tx = await merchantContract.confirmCouponPay(
                consumeValue,   // uint consumeValue
                dateBytes32,    // bytes32 consumeDate
                couponAddr,     // address couponAddr
                consumerAddr    // address _consumer
            );

            showStatus(`交易已发送! 等待确认... <br> Hash: ${tx.hash}`, "info");

            // 等待交易上链确认
            const receipt = await tx.wait();

            if (receipt.status === 1) {
                showStatus("✅ 核销成功！优惠券状态已更新。", "success");
            } else {
                showStatus("❌ 交易失败，请检查控制台日志。", "error");
            }

        } catch (error) {
            console.error("核销错误:", error);
            // 尝试解析错误信息
            let msg = error.reason || error.message || "未知错误";
            if (msg.includes("Only owner")) {
                msg = "错误：只有该商家的拥有者地址才能发起核销。";
            } else if (msg.includes("revert")) {
                msg = "合约执行回退：可能是金额不足限额，或优惠券无效。";
            }
            showStatus(msg, "error");
        }
    }

    // 辅助函数：显示状态
    function showStatus(msg, type) {
        const el = document.getElementById("status");
        el.innerHTML = msg;
        el.className = ""; // reset
        if (type === "error") el.classList.add("status-error");
        else if (type === "success") el.classList.add("status-success");
        else el.classList.add("status-info");
    }
</script>

</body>
</html>
