<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å®¶æ ¸é”€ç»ˆç«¯</title>
    <!-- å¼•å…¥ Ethers.js (v5.7.2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- å¼•å…¥ html5-qrcode æ‰«ç åº“ -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE5B4 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .container { 
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFEF7 100%);
            padding: 20px; 
            min-height: 100vh;
            width: 100%;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ‰«ç ç›¸å…³æ ·å¼ */
        #qr-reader {
            width: 100%;
            border: 2px solid #FFD54F;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        #qr-reader video {
            width: 100%;
            display: block;
        }
        
        .btn-scan {
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
            color: #5D4037;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-scan:hover:not(:disabled) {
            background: linear-gradient(135deg, #FFB300 0%, #FFA000 100%);
        }
        
        .btn-scan:disabled {
            background: #E0E0E0;
            color: #9E9E9E;
        }
        
        h2 { 
            text-align: center; 
            color: #F57C00;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            padding-top: 10px;
        }
        
        h3 {
            color: #F57C00;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            margin-top: 20px;
            text-align: left;
        }
        
        .group { 
            margin-bottom: 18px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #E65100;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        input { 
            width: 100%; 
            padding: 12px 14px; 
            border: 2px solid #FFE082; 
            border-radius: 8px; 
            box-sizing: border-box;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background: #FFFEF7;
        }
        
        input:focus {
            outline: none;
            border-color: #FFC107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
            background: #fff;
        }
        
        input:disabled {
            background: #FFF9E6;
            color: #999;
        }
        
        button { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn-connect { 
            background: linear-gradient(135deg, #FFD54F 0%, #FFC107 100%);
            color: #5D4037;
        }
        
        .btn-connect:hover {
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
        }
        
        .btn-verify { 
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
            color: #5D4037;
            font-size: 1.05em;
        }
        
        .btn-verify:hover:not(:disabled) {
            background: linear-gradient(135deg, #FFB300 0%, #FFA000 100%);
        }
        
        .btn-verify:disabled { 
            background: #E0E0E0;
            color: #9E9E9E;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #walletAddress {
            font-size: 0.8em;
            color: #795548;
            margin-top: 8px;
            text-align: center;
            font-weight: 400;
        }
        
        #status { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 12px; 
            font-size: 0.9em; 
            word-break: break-all;
            line-height: 1.6;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-info { 
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            color: #0D47A1;
            border: 2px solid #90CAF9;
        }
        
        .status-error { 
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            color: #C62828;
            border: 2px solid #EF9A9A;
        }
        
        .status-success { 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE082 100%);
            color: #F57C00;
            border: 2px solid #FFD54F;
        }
        
        .divider { 
            border-top: 2px dashed #FFE082; 
            margin: 20px 0;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>å•†å®¶æ ¸é”€ç»ˆç«¯</h2>

    <!-- è¿æ¥é’±åŒ… -->
    <div class="group">
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">è¿æ¥ MetaMask é’±åŒ…</button>
        <p id="walletAddress">æœªè¿æ¥</p>
    </div>

    <div class="group">
        <label>å•†å®¶åˆçº¦åœ°å€ (Merchant Contract):</label>
        <input type="text" id="merchantContractAddr" placeholder="0x...">
    </div>

    <div class="divider"></div>

    <h3>æ‰«ç æ“ä½œ</h3>
    
    <!-- æ‰«ç åŒºåŸŸ -->
    <div id="qr-reader" style="display: none;"></div>
    
    <div class="group">
        <button id="scanBtn" class="btn-scan" onclick="toggleScan()">
            ğŸ“· å¼€å¯æ‘„åƒå¤´æ‰«ç 
        </button>
    </div>

    <div class="divider"></div>

    <!-- æ‰«ç ç»“æœè‡ªåŠ¨å¡«å…¥ -->
    <div class="group">
        <label>ç”¨æˆ·åœ°å€ (Consumer):</label>
        <input type="text" id="consumerAddr" placeholder="æ‰«ç è‡ªåŠ¨å¡«å…¥" readonly>
    </div>
    <div class="group">
        <label>ä¼˜æƒ åˆ¸åœ°å€ (Coupon):</label>
        <input type="text" id="couponAddr" placeholder="æ‰«ç è‡ªåŠ¨å¡«å…¥" readonly>
    </div>

    <div class="divider"></div>

    <div class="group">
        <label>æœ¬æ¬¡æ¶ˆè´¹é‡‘é¢ (Consume Value):</label>
        <input type="number" id="consumeValue" placeholder="è¯·è¾“å…¥æ ¸é”€é‡‘é¢ (æ•´æ•°)">
    </div>

    <button id="verifyBtn" class="btn-verify" onclick="verifyCoupon()" disabled>ç¡®è®¤æ ¸é”€ (ä¸Šé“¾)</button>

    <div id="status"></div>
</div>

<script>
    let provider;
    let signer;
    let userAddress;
    let html5QrCode;
    let isScanning = false;

    // Merchant åˆçº¦ ABI
    const merchantAbi = [
        "function confirmCouponPay(uint consumeValue, bytes32 consumeDate, address couponAddr, address _consumer)"
    ];

    // åˆå§‹åŒ–æ£€æŸ¥
    window.onload = function() {
        if (typeof window.ethereum === 'undefined') {
            showStatus("æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å®‰è£…æ’ä»¶ã€‚", "error");
        }
        // åˆå§‹åŒ–æ‰«ç å™¨
        html5QrCode = new Html5Qrcode("qr-reader");
    };

    // 1. è¿æ¥é’±åŒ…
    async function connectWallet() {
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();

            document.getElementById("walletAddress").innerText = "å½“å‰å•†å®¶è´¦æˆ·: " + userAddress.substring(0, 6) + "..." + userAddress.substring(38);
            document.getElementById("connectBtn").innerText = "é’±åŒ…å·²è¿æ¥";
            document.getElementById("verifyBtn").disabled = false;
            showStatus("âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼", "success");
        } catch (error) {
            console.error(error);
            showStatus("è¿æ¥å¤±è´¥: " + error.message, "error");
        }
    }

    // 2. æ‰«ç åŠŸèƒ½
    async function toggleScan() {
        const qrReaderDiv = document.getElementById("qr-reader");
        const scanBtn = document.getElementById("scanBtn");
        
        if (!isScanning) {
            // å¼€å§‹æ‰«ç 
            try {
                qrReaderDiv.style.display = "block";
                scanBtn.innerText = "â¹ åœæ­¢æ‰«ç ";
                scanBtn.disabled = true;
                
                await html5QrCode.start(
                    { facingMode: "environment" }, // ä½¿ç”¨åç½®æ‘„åƒå¤´
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    onScanFailure
                );
                
                isScanning = true;
                scanBtn.disabled = false;
                showStatus("ğŸ“· æ‘„åƒå¤´å·²å¼€å¯ï¼Œè¯·å¯¹å‡†äºŒç»´ç ", "info");
            } catch (err) {
                console.error("å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:", err);
                qrReaderDiv.style.display = "none";
                scanBtn.innerText = "ğŸ“· å¼€å¯æ‘„åƒå¤´æ‰«ç ";
                scanBtn.disabled = false;
                showStatus("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err.message + " (è¯·ç¡®ä¿å·²æˆæƒæ‘„åƒå¤´æƒé™)", "error");
            }
        } else {
            // åœæ­¢æ‰«ç 
            try {
                await html5QrCode.stop();
                qrReaderDiv.style.display = "none";
                scanBtn.innerText = "ğŸ“· å¼€å¯æ‘„åƒå¤´æ‰«ç ";
                isScanning = false;
                showStatus("æ‘„åƒå¤´å·²å…³é—­", "info");
            } catch (err) {
                console.error("åœæ­¢æ‰«ç å¤±è´¥:", err);
            }
        }
    }

    // æ‰«ç æˆåŠŸå›è°ƒ
    function onScanSuccess(decodedText, decodedResult) {
        console.log("æ‰«ç æˆåŠŸ:", decodedText);
        
        try {
            // è§£æäºŒç»´ç å†…å®¹ (å‡è®¾æ ¼å¼ä¸º JSON: {"consumer":"0x...", "coupon":"0x..."})
            const data = JSON.parse(decodedText);
            
            if (data.consumer && data.coupon) {
                document.getElementById("consumerAddr").value = data.consumer;
                document.getElementById("couponAddr").value = data.coupon;
                showStatus("âœ… æ‰«ç æˆåŠŸï¼å·²è‡ªåŠ¨å¡«å…¥åœ°å€", "success");
                
                // è‡ªåŠ¨åœæ­¢æ‰«ç 
                toggleScan();
            } else {
                showStatus("äºŒç»´ç æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å­—æ®µ", "error");
            }
        } catch (e) {
            // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•æŒ‰é€—å·åˆ†éš”è§£æ
            const parts = decodedText.split(',');
            if (parts.length === 2) {
                document.getElementById("consumerAddr").value = parts[0].trim();
                document.getElementById("couponAddr").value = parts[1].trim();
                showStatus("âœ… æ‰«ç æˆåŠŸï¼å·²è‡ªåŠ¨å¡«å…¥åœ°å€", "success");
                toggleScan();
            } else {
                showStatus("äºŒç»´ç æ ¼å¼é”™è¯¯ï¼š" + decodedText, "error");
            }
        }
    }

    // æ‰«ç å¤±è´¥å›è°ƒï¼ˆé™é»˜å¤„ç†ï¼‰
    function onScanFailure(error) {
        // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…é¢‘ç¹æç¤º
    }

    // 3. æ ¸å¿ƒæ ¸é”€å‡½æ•°
    async function verifyCoupon() {
        // è·å–è¾“å…¥å€¼
        const merchantContractAddr = document.getElementById("merchantContractAddr").value.trim();
        const consumerAddr = document.getElementById("consumerAddr").value.trim();
        const couponAddr = document.getElementById("couponAddr").value.trim();
        const consumeValue = document.getElementById("consumeValue").value.trim();

        // åŸºç¡€æ ¡éªŒ
        if (!ethers.utils.isAddress(merchantContractAddr)) return showStatus("å•†å®¶åˆçº¦åœ°å€æ— æ•ˆ", "error");
        if (!ethers.utils.isAddress(consumerAddr)) return showStatus("ç”¨æˆ·åœ°å€æ— æ•ˆ", "error");
        if (!ethers.utils.isAddress(couponAddr)) return showStatus("ä¼˜æƒ åˆ¸åœ°å€æ— æ•ˆ", "error");
        if (!consumeValue || consumeValue <= 0) return showStatus("æ¶ˆè´¹é‡‘é¢å¿…é¡»å¤§äº0", "error");

        try {
            showStatus("æ­£åœ¨å‘èµ·äº¤æ˜“ï¼Œè¯·åœ¨ MetaMask ä¸­ç¡®è®¤...", "info");

            // å®ä¾‹åŒ–åˆçº¦
            const merchantContract = new ethers.Contract(merchantContractAddr, merchantAbi, signer);

            // ç”Ÿæˆæ—¥æœŸ (bytes32)
            // åˆçº¦è¦æ±‚ bytes32 ç±»å‹çš„æ—¥æœŸã€‚æˆ‘ä»¬å°†å½“å‰æ—¥æœŸå­—ç¬¦ä¸² (å¦‚ "2023-11-29") è½¬ä¸º bytes32
            const todayStr = new Date().toISOString().split('T')[0]; 
            const dateBytes32 = ethers.utils.formatBytes32String(todayStr);

            console.log("å‚æ•°è¯¦æƒ…:", {
                value: consumeValue,
                date: dateBytes32,
                coupon: couponAddr,
                consumer: consumerAddr
            });

            // è°ƒç”¨åˆçº¦å‡½æ•°: confirmCouponPay
            const tx = await merchantContract.confirmCouponPay(
                consumeValue,   // uint consumeValue
                dateBytes32,    // bytes32 consumeDate
                couponAddr,     // address couponAddr
                consumerAddr    // address _consumer
            );

            showStatus(`äº¤æ˜“å·²å‘é€! ç­‰å¾…ç¡®è®¤... <br> Hash: ${tx.hash}`, "info");

            // ç­‰å¾…äº¤æ˜“ä¸Šé“¾ç¡®è®¤
            const receipt = await tx.wait();

            if (receipt.status === 1) {
                showStatus("âœ… æ ¸é”€æˆåŠŸï¼ä¼˜æƒ åˆ¸çŠ¶æ€å·²æ›´æ–°ã€‚", "success");
            } else {
                showStatus("âŒ äº¤æ˜“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚", "error");
            }

        } catch (error) {
            console.error("æ ¸é”€é”™è¯¯:", error);
            // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
            let msg = error.reason || error.message || "æœªçŸ¥é”™è¯¯";
            if (msg.includes("Only owner")) {
                msg = "é”™è¯¯ï¼šåªæœ‰è¯¥å•†å®¶çš„æ‹¥æœ‰è€…åœ°å€æ‰èƒ½å‘èµ·æ ¸é”€ã€‚";
            } else if (msg.includes("revert")) {
                msg = "åˆçº¦æ‰§è¡Œå›é€€ï¼šå¯èƒ½æ˜¯é‡‘é¢ä¸è¶³é™é¢ï¼Œæˆ–ä¼˜æƒ åˆ¸æ— æ•ˆã€‚";
            }
            showStatus(msg, "error");
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºçŠ¶æ€
    function showStatus(msg, type) {
        const el = document.getElementById("status");
        el.innerHTML = msg;
        el.className = ""; // reset
        if (type === "error") el.classList.add("status-error");
        else if (type === "success") el.classList.add("status-success");
        else el.classList.add("status-info");
    }
</script>

</body>
</html>
