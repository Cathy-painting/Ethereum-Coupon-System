<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¼˜æƒ åˆ¸ - ç”¨æˆ·ç«¯</title>
    <!-- å¼•å…¥ Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- å¼•å…¥ QRCode.js ç”¨äºç”ŸæˆäºŒç»´ç  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE5B4 100%);
            min-height: 100vh;
            padding: 40px 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            justify-content: center;
        }
        
        .container { 
            width: 100%; 
            max-width: 900px; 
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card { 
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFEF7 100%);
            padding: 45px 50px; 
            border-radius: 24px; 
            box-shadow: 0 12px 48px rgba(255, 193, 7, 0.25);
            margin-bottom: 30px;
            border: 3px solid #FFD54F;
        }
        
        h2 { 
            margin-top: 0; 
            color: #F57C00;
            font-size: 1.8em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(255, 193, 7, 0.1);
        }
        
        h3 {
            margin-top: 0;
            color: #F57C00;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        label {
            display: block;
            color: #E65100;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        input { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #FFE082; 
            border-radius: 12px; 
            box-sizing: border-box; 
            margin-top: 5px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background: #FFFEF7;
        }
        
        input:focus {
            outline: none;
            border-color: #FFC107;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }
        
        button { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600;
            margin-top: 12px; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
            color: #5D4037;
        }
        
        .btn-primary:hover { 
            background: linear-gradient(135deg, #FFB300 0%, #FFA000 100%);
        }
        
        .btn-connect { 
            background: linear-gradient(135deg, #FFD54F 0%, #FFC107 100%);
            color: #5D4037;
        }
        
        .btn-connect:hover {
            background: linear-gradient(135deg, #FFC107 0%, #FFB300 100%);
        }
        
        #walletAddress {
            font-size: 0.85em;
            color: #795548;
            margin-top: 10px;
            padding: 10px;
            background: #FFF9E6;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        
        /* ä¼˜æƒ åˆ¸åˆ—è¡¨æ ·å¼ */
        .coupon-list { 
            display: grid; 
            gap: 20px;
            margin-top: 10px;
        }
        
        .coupon-item { 
            border: 2px solid #FFE082; 
            padding: 20px; 
            border-radius: 16px; 
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFEF7 100%);
            position: relative; 
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 193, 7, 0.15);
        }
        
        .coupon-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(255, 193, 7, 0.25);
        }
        
        .coupon-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #FFC107 0%, #FFB300 100%);
        }
        
        .coupon-item.used { 
            background: linear-gradient(135deg, #F5F5F5 0%, #EEEEEE 100%);
            color: #999; 
            border-color: #E0E0E0;
            opacity: 0.7;
        }
        
        .coupon-item.used::before {
            background: #BDBDBD;
        }
        
        .coupon-item.valid::before {
            background: linear-gradient(180deg, #FFC107 0%, #FF6F00 100%);
        }
        
        .coupon-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
        }
        
        .coupon-value { 
            font-size: 2em; 
            font-weight: 800; 
            background: linear-gradient(135deg, #FF6F00 0%, #FFA000 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .coupon-limit { 
            font-size: 0.95em; 
            color: #795548;
            margin-top: 5px;
            font-weight: 500;
        }
        
        .tag { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.8em;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .tag-valid { 
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE082 100%);
            color: #F57C00;
            border: 1px solid #FFD54F;
        }
        
        .tag-used { 
            background: #E0E0E0; 
            color: #757575;
        }
        
        .coupon-date {
            font-size: 0.85em;
            color: #8D6E63;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .coupon-id {
            font-size: 0.75em;
            color: #BCAAA4;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #FFE082;
        }

        /* æ¨¡æ€æ¡† (äºŒç»´ç ) */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal { 
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFEF7 100%);
            padding: 35px; 
            border-radius: 20px; 
            text-align: center; 
            max-width: 90%; 
            position: relative;
            border: 3px solid #FFD54F;
            box-shadow: 0 12px 48px rgba(255, 193, 7, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            font-size: 28px; 
            cursor: pointer; 
            color: #FFA000;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background: #FFF9E6;
            transform: rotate(90deg);
        }
        
        #qrcode { 
            margin: 25px auto; 
            display: flex; 
            justify-content: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .qr-info { 
            font-size: 0.85em; 
            color: #795548; 
            word-break: break-all; 
            background: #FFF9E6; 
            padding: 15px; 
            border-radius: 10px;
            border: 1px solid #FFE082;
            margin-top: 15px;
        }
        
        #loading {
            text-align: center;
            padding: 20px;
            color: #F57C00;
            font-weight: 600;
            font-size: 1.1em;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8D6E63;
            font-size: 1.1em;
        }
        
        /* è½¬èµ æ¨¡æ€æ¡†æ ·å¼ */
        .transfer-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .transfer-modal {
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFEF7 100%);
            padding: 35px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            position: relative;
            border: 3px solid #FFD54F;
            box-shadow: 0 12px 48px rgba(255, 193, 7, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .transfer-modal h3 {
            color: #F57C00;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .transfer-modal-content {
            margin-top: 20px;
        }
        
        .transfer-modal-content label {
            display: block;
            margin-bottom: 8px;
            color: #E65100;
            font-weight: 600;
        }
        
        .transfer-modal-content input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #FFE082;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .transfer-modal-content button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #FFA726 0%, #FF9800 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .transfer-modal-content button:hover {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        #transferStatus {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ç”¨æˆ·ç«¯ - æˆ‘çš„ä¼˜æƒ åˆ¸</h2>
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">è¿æ¥ MetaMask</button>
        <div id="walletAddress"></div>
        
        <div style="margin-top: 15px;">
            <label>è¯·è¾“å…¥æ‚¨çš„æ¶ˆè´¹è€…åˆçº¦åœ°å€ (Consumer Contract):</label>
            <input type="text" id="consumerContractAddr" placeholder="0x..." />
            <button class="btn-primary" onclick="loadCoupons()">æŸ¥è¯¢æˆ‘çš„ä¼˜æƒ åˆ¸</button>
        </div>
    </div>

    <div id="loading" style="text-align: center; display: none;">æ­£åœ¨è¯»å–é“¾ä¸Šæ•°æ®...</div>

    <div id="couponList" class="coupon-list">
        <!-- ä¼˜æƒ åˆ¸å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
    </div>
</div>

<!-- äºŒç»´ç å¼¹çª— -->
<div id="qrModal" class="modal-overlay">
    <div class="modal">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>å‘å•†å®¶å‡ºç¤ºæ­¤ç </h3>
        <div id="qrcode"></div>
        <p>æ‰«ç ä¿¡æ¯ (Json):</p>
        <div id="qrText" class="qr-info"></div>
        <p style="font-size: 0.85em; color: #8D6E63; margin-top:15px; line-height: 1.5;">å•†å®¶å¡«å…¥å·¦è¾¹çš„æ¶ˆè´¹è€…åœ°å€å’Œå³è¾¹çš„ä¼˜æƒ åˆ¸åœ°å€å³å¯æ ¸é”€</p>
    </div>
</div>

<!-- è½¬èµ æ¨¡æ€æ¡† -->
<div id="transferModal" class="transfer-modal-overlay">
    <div class="transfer-modal">
        <span class="close-btn" onclick="closeTransferModal()">&times;</span>
        <h3>è½¬èµ ä¼˜æƒ åˆ¸</h3>
        <div class="transfer-modal-content">
            <input type="hidden" id="transferConsumerAddr" />
            <input type="hidden" id="transferCouponAddr" />
            <label>æ¥æ”¶æ–¹Consumeråˆçº¦åœ°å€:</label>
            <input type="text" id="transferToAddr" />
            <button onclick="executeTransfer()">è½¬èµ </button>
            <div id="transferStatus"></div>
        </div>
    </div>
</div>

<script>
    let provider, signer;
    
    // ABI å®šä¹‰
    // Consumeråˆçº¦ï¼šæˆ‘ä»¬éœ€è¦ getCoupons()
    const consumerAbi = [
        "function getCoupons() public view returns(address[] memory)",
        "function transfer(address newConsumer, address _coupon)"
    ];
    // Couponåˆçº¦ï¼šæˆ‘ä»¬éœ€è¦æŸ¥çœ‹è¯¦æƒ…
    const couponAbi = [
        "function getValue() public view returns(uint)",
        "function getLimit() public view returns(uint)",
        "function getState() public view returns(uint)",
        "function getEndDate() public view returns(bytes32)"
    ];

    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') return alert("è¯·å®‰è£… MetaMask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            document.getElementById("walletAddress").innerText = "å·²è¿æ¥: " + addr;
            document.getElementById("connectBtn").innerText = "é’±åŒ…å·²è¿æ¥";
        } catch (e) {
            console.error(e);
            alert("è¿æ¥å¤±è´¥");
        }
    }

    async function loadCoupons() {
        const consumerAddr = document.getElementById("consumerContractAddr").value.trim();
        if (!ethers.utils.isAddress(consumerAddr)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè´¹è€…åˆçº¦åœ°å€");
        if (!signer) return alert("è¯·å…ˆè¿æ¥é’±åŒ…");

        const listContainer = document.getElementById("couponList");
        listContainer.innerHTML = "";
        document.getElementById("loading").style.display = "block";

        try {
            const consumerContract = new ethers.Contract(consumerAddr, consumerAbi, signer);
            
            // 1. è·å–å½“å‰æ‹¥æœ‰çš„ä¼˜æƒ åˆ¸åœ°å€
            const currentCoupons = await consumerContract.getCoupons();
            
            // 2. ä» localStorage è·å–å†å²ä¼˜æƒ åˆ¸è®°å½•
            const storageKey = `coupons_${consumerAddr}`;
            let historyCoupons = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // 3. åˆå¹¶å½“å‰ä¼˜æƒ åˆ¸åˆ°å†å²è®°å½•ï¼ˆå»é‡ï¼‰
            for (let addr of currentCoupons) {
                if (!historyCoupons.includes(addr)) {
                    historyCoupons.push(addr);
                }
            }
            
            // 4. ä¿å­˜æ›´æ–°åçš„å†å²è®°å½•
            localStorage.setItem(storageKey, JSON.stringify(historyCoupons));
            
            if (historyCoupons.length === 0) {
                listContainer.innerHTML = "<div class='empty-state'>ğŸ« æš‚æ— ä¼˜æƒ åˆ¸</div>";
                document.getElementById("loading").style.display = "none";
                return;
            }

            // 5. éå†æ‰€æœ‰å†å²ä¼˜æƒ åˆ¸è·å–è¯¦æƒ…
            for (let cAddr of historyCoupons) {
                const cContract = new ethers.Contract(cAddr, couponAbi, signer);
                
                // è¯»å–æ•°æ®
                const val = await cContract.getValue();
                const limit = await cContract.getLimit();
                const state = await cContract.getState(); // 1:æ–°åˆ›å»º, 2:å·²å‘æ”¾(å¯ç”¨), 3:å·²æ ¸é”€
                const endDateBytes = await cContract.getEndDate();
                
                // å¤„ç†æ—¥æœŸï¼šå¦‚æœæ˜¯å…¨0ï¼Œæ˜¾ç¤º"æ°¸ä¹…æœ‰æ•ˆ"
                let endDateStr = "æ°¸ä¹…æœ‰æ•ˆ";
                try {
                    const parsed = ethers.utils.parseBytes32String(endDateBytes);
                    if (parsed && parsed.trim()) {
                        endDateStr = parsed;
                    }
                } catch (e) {
                    // è§£æå¤±è´¥ï¼Œä¿æŒé»˜è®¤å€¼
                }

                // æ¸²æŸ“ UIï¼ˆåŒ…æ‹¬å·²æ ¸é”€çš„ï¼‰
                renderCoupon(cAddr, consumerAddr, val, limit, state, endDateStr);
            }

        } catch (e) {
            console.error(e);
            alert("è¯»å–å¤±è´¥: " + (e.reason || e.message));
        } finally {
            document.getElementById("loading").style.display = "none";
        }
    }

    function renderCoupon(couponAddr, consumerAddr, value, limit, state, endDate) {
        const list = document.getElementById("couponList");
        
        // çŠ¶æ€åˆ¤æ–­
        // state: 2 (å·²å‘æ”¾/æœªä½¿ç”¨) æ˜¯æˆ‘ä»¬æœ€å…³å¿ƒçš„ã€‚3 æ˜¯å·²ä½¿ç”¨ã€‚
        let statusClass = "used";
        let statusText = "æœªçŸ¥çŠ¶æ€";
        let canUse = false;

        if (state.toString() === "2") {
            statusClass = "valid";
            statusText = "æœªä½¿ç”¨";
            canUse = true;
        } else if (state.toString() === "3") {
            statusClass = "used";
            statusText = "å·²æ ¸é”€";
        } else if (state.toString() === "1") {
            statusText = "æœªå‘æ”¾"; // ç†è®ºä¸Šç”¨æˆ·æ‹¿ä¸åˆ°çŠ¶æ€1çš„åˆ¸ï¼Œé™¤éé€»è¾‘ç‰¹æ®Š
        }

        const div = document.createElement("div");
        div.className = `coupon-item ${statusClass}`;
        div.innerHTML = `
            <div class="coupon-header">
                <span class="tag tag-${canUse ? 'valid' : 'used'}">${statusText}</span>
                <span class="coupon-date">ğŸ“… ${endDate}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top: 10px;">
                <div>
                    <div class="coupon-value">Â¥ ${value}</div>
                    <div class="coupon-limit">æ»¡ ${limit} å¯ç”¨</div>
                </div>
                ${canUse ? `
                    <div style="display:flex; gap:8px;">
                        <button class="btn-primary" style="width:auto; padding:10px 20px; margin:0;" 
                            onclick="showQR('${consumerAddr}', '${couponAddr}')">å‡ºç¤ºäºŒç»´ç </button>
                        <button class="btn-secondary" style="width:auto; padding:10px 20px; margin:0; background: linear-gradient(135deg, #FFA726 0%, #FF9800 100%);" 
                            onclick="showTransferModal('${consumerAddr}', '${couponAddr}')">è½¬èµ </button>
                    </div>` : ''}
            </div>
            <div class="coupon-id">ä¼˜æƒ åˆ¸ID: ${couponAddr.substring(0,10)}...${couponAddr.substring(couponAddr.length-8)}</div>
        `;
        list.appendChild(div);
    }

    function showQR(consumerAddr, couponAddr) {
        // ç”ŸæˆäºŒç»´ç æ•°æ®
        // è¿™é‡Œçš„æ ¼å¼å¯ä»¥æ ¹æ®å®é™…æ‰«ç æª/APPéœ€æ±‚å®šï¼Œè¿™é‡Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªJSONå­—ç¬¦ä¸²
        // æ–¹ä¾¿æˆ‘ä»¬åˆšæ‰å†™çš„å•†å®¶ç«¯å¤åˆ¶ç²˜è´´
        /* 
           æ³¨æ„ï¼šåœ¨çœŸå®çš„ç§»åŠ¨ç«¯DAppä¸­ï¼Œå•†å®¶æ‰«ç åä¼šè‡ªåŠ¨è§£æ
           è¿™é‡Œä¸ºäº†é…åˆåˆšæ‰çš„ç½‘é¡µç‰ˆå•†å®¶ç«¯ï¼Œæˆ‘ä»¬å±•ç¤ºæ–‡æœ¬è®©ç”¨æˆ·çœ‹
        */
        const qrData = JSON.stringify({
            consumer: consumerAddr,
            coupon: couponAddr
        });

        // æ¸…ç©ºæ—§ç 
        document.getElementById("qrcode").innerHTML = "";
        document.getElementById("qrText").innerText = `ç”¨æˆ·: ${consumerAddr}\nåˆ¸: ${couponAddr}`;

        // ç”Ÿæˆæ–°ç 
        new QRCode(document.getElementById("qrcode"), {
            text: qrData,
            width: 200,
            height: 200
        });

        document.getElementById("qrModal").style.display = "flex";
    }

    function closeModal() {
        document.getElementById("qrModal").style.display = "none";
    }
    
    // æ˜¾ç¤ºè½¬èµ æ¨¡æ€æ¡†
    function showTransferModal(consumerAddr, couponAddr) {
        document.getElementById("transferConsumerAddr").value = consumerAddr;
        document.getElementById("transferCouponAddr").value = couponAddr;
        document.getElementById("transferToAddr").value = "";
        document.getElementById("transferModal").style.display = "flex";
    }
    
    // å…³é—­è½¬èµ æ¨¡æ€æ¡†
    function closeTransferModal() {
        document.getElementById("transferModal").style.display = "none";
    }
    
    // æ‰§è¡Œè½¬èµ 
    async function executeTransfer() {
        const consumerAddr = document.getElementById("transferConsumerAddr").value.trim();
        const couponAddr = document.getElementById("transferCouponAddr").value.trim();
        const toAddr = document.getElementById("transferToAddr").value.trim();
        
        if (!ethers.utils.isAddress(toAddr)) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ¥æ”¶æ–¹Consumeråˆçº¦åœ°å€");
            return;
        }
        
        if (!signer) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦å°†æ­¤ä¼˜æƒ åˆ¸è½¬èµ ç»™:\n${toAddr}\n\nè½¬èµ åæ‚¨å°†å¤±å»æ­¤ä¼˜æƒ åˆ¸çš„æ‰€æœ‰æƒã€‚`)) {
            return;
        }
        
        try {
            document.getElementById("transferStatus").innerHTML = "<div style='color: #2196F3;'>â³ æ­£åœ¨å‘èµ·è½¬èµ äº¤æ˜“ï¼Œè¯·åœ¨ MetaMask ä¸­ç¡®è®¤...</div>";
            
            const consumerContract = new ethers.Contract(consumerAddr, consumerAbi, signer);
            const tx = await consumerContract.transfer(toAddr, couponAddr);
            
            document.getElementById("transferStatus").innerHTML = `<div style='color: #2196F3;'>â³ äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤...<br>Hash: ${tx.hash}</div>`;
            
            const receipt = await tx.wait();
            
            if (receipt.status === 1) {
                document.getElementById("transferStatus").innerHTML = "<div style='color: #4CAF50;'>âœ… è½¬èµ æˆåŠŸï¼ä¼˜æƒ åˆ¸å·²è½¬ç§»åˆ°æ¥æ”¶æ–¹è´¦æˆ·ã€‚</div>";
                
                // 3ç§’åå…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
                setTimeout(() => {
                    closeTransferModal();
                    loadCoupons();
                }, 3000);
            } else {
                document.getElementById("transferStatus").innerHTML = "<div style='color: #F44336;'>âŒ äº¤æ˜“å¤±è´¥</div>";
            }
        } catch (error) {
            console.error("è½¬èµ é”™è¯¯:", error);
            let errorMsg = error.reason || error.message || "æœªçŸ¥é”™è¯¯";
            if (errorMsg.includes("user rejected")) {
                errorMsg = "ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“";
            }
            document.getElementById("transferStatus").innerHTML = `<div style='color: #F44336;'>âŒ è½¬èµ å¤±è´¥: ${errorMsg}</div>`;
        }
    }
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­
    window.onclick = function(event) {
        const qrModal = document.getElementById("qrModal");
        const transferModal = document.getElementById("transferModal");
        if (event.target == qrModal) {
            qrModal.style.display = "none";
        }
        if (event.target == transferModal) {
            transferModal.style.display = "none";
        }
    }
</script>

</body>
</html>